#!/bin/bash
# Pre-commit hook to check for unused files and always dump the latest database data
# Install this hook by running:
# cp utils/git-hooks/pre-commit .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit

# Set the working directory to the project root
cd "$(git rev-parse --show-toplevel)"

# Always dump the latest data before every commit
python3 manage.py dumpdata --natural-foreign --natural-primary --indent 2 > positionfinder/fixtures/databasedump.json
if [ $? -ne 0 ]; then
    echo -e "\n❌ Commit prevented: Could not dump database data."
    exit 1
fi

# Check for conda environment first
if command -v conda &> /dev/null; then
    # Use eval to work around potential conda initialization issues
    eval "$(conda shell.bash hook)"
    conda activate fretboard
# Fall back to venv if conda is not available
elif [ -d "venv" ]; then
    source venv/bin/activate
fi

echo "Running unused files test..."
python3 manage.py test positionfinder.test_unused_files.UnusedFilesTestCase.test_high_confidence_files_removed -v 1

# If the test fails, prevent the commit
if [ $? -ne 0 ]; then
    echo -e "\n❌ Commit prevented: Some unused files need to be removed."
    echo "Please run ./utils/cleanup_unused.sh before committing."
    exit 1
fi

# If the test passes, allow the commit
echo -e "\n✅ Unused files check passed."
exit 0
